YUI.add("gallery-dp-editable",function(a){function l(){this.publish("save",{defaultFn:this._defFnSave}),this.publish("cancel",{defaultFn:this._defFnCancel}),this.after("savingChange",this._uiSetSaving,this),this.after("editingChange",this._uiSetEditing,this)}var b=a.Lang,c=a.ClassNameManager.getClassName,d=c("gallery","dp","editable"),e=d+"-form",f=d+"-input",g=d+"-submit",h=d+"-cancel",i=d+"-placeholder",j=d+"-field",k=d+"-field-saving";a.mix(l,{NAME:"editableBase",ATTRS:{strings:{value:{tooltip:"Click to edit...",cancel:"Cancel",submit:"OK",indicator:"Saving...",placeholder:"Click to edit..."}},targetnode:{value:null},editingnode:{value:null},event:{value:"click"},prevContent:{value:null},type:{value:"text",validator:"_validateAttrType"},rows:{value:null},cols:{value:null},submitto:{value:null},method:{value:"POST"},loadfrom:{value:null},editing:{value:!1},saving:{value:!1},select:{value:!1},inputWidth:{value:"auto"},inputHeight:{value:"auto"},onblur:{value:"cancel"},delegate:{value:null}}}),l.prototype={destructor:function(){this.get("targetnode").detach(this.get("event"))},_bindEditableBase:function(){null===this.get("delegate")?this.get("targetnode").on(this.get("event"),a.bind(this._onClick,this)):this.get("targetnode").delegate(this.get("event"),this._onClick,this.get("delegate"),this)},_syncEditableBase:function(){var a;null===this.get("delegate")?a=this.get("editingnode"):a=this.get("targetnode").all(this.get("delegate")),a.set("title",this.get("strings.tooltip")),a.addClass(j),this.get("targetnode").get("innerHTML").length===0&&this.get("targetnode").append(this._renderPlaceHolder())},_renderPlaceHolder:function(){return a.Node.create(a.substitute(this.TEMPLATE_PLACEHOLDER,{className:i,text:this.get("strings.placeholder")}))},_validateAttrType:function(a){return"textarea"===a||"text"===a||"select"===a?!0:!1},_onClick:function(a){var b=this.get("editingnode");a.halt();if(this.get("editing")===!0&&b!==null&&b.contains(a.target))return!1;this.get("editing")===!0&&a.currentTarget.get("id")!==b.get("id")&&this.save(),this.edit(a.currentTarget)},_onClickCancel:function(a){a.stopPropagation(),this.discard()},_onClickSave:function(a){a.stopPropagation(),this.save()},_onKey:function(a){a.halt(),a.keyCode==27?this.discard():a.keyCode==13&&this.save()},_uiSetSaving:function(a){null!=this.get("editingnode")&&(!0===this.get("saving")?this.get("editingnode").addClass(k):this.get("editingnode").removeClass(k))},_uiSetEditing:function(b){if(!0===this.get("editing")){if(!0===b.prevVal)return!1;var c=this._renderForm(),d=this.get("editingnode"),e=this.get("editingnode").one("."+i),f,g=this.get("loadfrom");this.set("prevContent",d.get("innerHTML")),e&&e.remove(),a.Lang.isFunction(g)?f=g(d):a.Lang.isString(g)||a.Lang.isNull(g)&&(f=d.get("textContent")),d.set("innerHTML",""),d.append(c),this._input.set("value",f),this._input.focus(),!0===this.get("select")&&this._input.select()}},_defFnSave:function(a){},_defFnCancel:function(){},_renderForm:function(){var b=this.get("type"),c=a.Node.create(a.substitute(this.TEMPLATE_FORM,{className:e})),d,i,j=this.get("inputWidth"),k=this.get("inputHeight");switch(b){case"textarea":d=a.Node.create(a.substitute(this.TEMPLATE_INPUT_TEXTAREA,{className:f})),this.get("rows")!==null&&d.setAttribute("rows",this.get("rows")),this.get("cols")!==null&&d.setAttribute("cols",this.get("cols"));break;case"select":d=a.Node.create(a.substitute(this.TEMPLATE_INPUT_SELECT,{className:f}));break;case"text":default:d=a.Node.create(a.substitute(this.TEMPLATE_INPUT_TEXT,{className:f}))}return j!=="auto"&&d.setStyle("width",j),k!=="auto"&&d.setStyle("height",k),this._input=d,this._input.on("key",this._onKey,"enter",this),this._input.on("key",this._onKey,"esc",this),c.append(this._input),i=a.Node.create(a.substitute(this.TEMPLATE_BUTTONS,{classNameSubmit:g,classNameCancel:h,labelSubmit:this.get("strings.submit"),labelCancel:this.get("strings.cancel")})),i.one("."+h).on("click",this._onClickCancel,this),i.one("."+g).on("click",this._onClickSave,this),c.append(i),c},edit:function(a){this.set("editingnode",a),this.set("editing",!0)},save:function(){var b=this.get("editingnode"),c=this.get("submitto");this.set("saving",!0);if(a.Lang.isFunction(c))c(b,a.bind(this.saveComplete,this)),this.set("editing",!1);else if(a.Lang.isString(c)){var d=this._input.get("value");this.get("editingnode").set("innerHTML",""),this.get("editingnode").append(d),a.io(a.substitute(c,{value:this._input.get("value")}),{on:{start:function(a,b,c){this.set("saving",!0)},success:function(a,b,c){this.set("saving",!1),this.set("editing",!1),this.fire("save",b)},failure:function(a,b,c){this.set("saving",!1),this.set("editing",!1),this.get("editingnode").set("innerHTML",this.get("prevContent"))}},context:this,arguments:{node:b}})}else if(null===c){var d=this._input.get("value");this.get("editingnode").set("innerHTML",""),this.get("editingnode").append(d),this.set("editing",!1),this.set("saving",!1),this.set("prevContent",null),this.set("editingnode",null)}},saveComplete:function(){this.fire("save"),this.set("saving",!1),this.set("prevContent",null),this.set("editingnode",null)},requestSave:function(b,c){var d=this.get("submitto"),e=this.get("fnSubmitValues")!==null?this.get("fnSubmitValues")(this.get("editingnode"),b):{value:b};a.Lang.isString(d)?a.io(a.substitute(d,e),{on:{start:this._uiSetSaving,success:this._uiSetSaveSuccess,failure:this._uiSetSaveFailure},context:this,arguments:{value:b,node:c}}):a.Lang.isFunction(d)&&d()},discard:function(){var a=this.get("editingnode");a.set("innerHTML",this.get("prevContent")),this.set("prevContent",null),this.set("editingnode",null),this.set("editing",!1),this.fire("cancel")},clear:function(){var a=this.get("editingnode"),b=this.get("targetnode");b.set("innerHTML",""),b.append(this._renderPlaceHolder()),this.set("prevContent",null),this.set("editing",!1)},TEMPLATE_FORM:'<form class="{className}"></form>',TEMPLATE_INPUT_TEXT:'<input type="text" class="{className}"></input>',TEMPLATE_INPUT_TEXTAREA:'<textarea class="{className}"></textarea>',TEMPLATE_INPUT_SELECT:'<select class="{className}"></select>',TEMPLATE_BUTTONS:'<input type="button" value="{labelCancel}" class="{classNameCancel}"></input><input type="button" value="{labelSubmit}" class="{classNameSubmit}"></input>',TEMPLATE_PLACEHOLDER:'<span class="{className}">{text}</span>',_input:null},a.namespace("DP").EditableBase=l;var m=a.Base.create("editablePlugin",a.Plugin.Base,[a.DP.EditableBase],{initializer:function(a){this.set("targetnode",a.host),a.delegate||this.set("editingnode",a.host),this._bindEditableBase(),this._syncEditableBase()}},{NS:"editable",NAME:"editable"});a.namespace("DP").EditablePlugin=m},"1.0.0",{requires:["node","base","event","plugin","io"]})