<!DOCTYPE html>
<html>
    <head>
        <title>Y.Plugin.DataTableEvents Test</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="http://yui.yahooapis.com/3.3.0/build/yui/yui-min.js"
        charset="utf-8"></script>
    </head>
    <body class="yui3-skin-sam">
        <script type="text/javascript">
            (function() {
                YUI({
                    filter: (window.location.search.match(/[?&]filter=([^&]+)/) || [])[1] || 'min',
                    //useBrowserConsole: true,
                    allowRollup: false,
                    modules : {
                        'gallery-datatable-tableevents' : {
                            'fullpath' : '../../../build/gallery-datatable-tableevents/gallery-datatable-tableevents-debug.js',
                            'requires' : ['datatable']
                        }
                    }
                }).use(
                    "console"
                    ,"test"
                    ,"dump"
                    ,"gallery-datatable-tableevents"
                    ,"node-event-simulate"
                    ,function(Y) {
                    
                
                    var myConsole = new Y.Console().render();

                    var testBasic = new Y.Test.Case({ 
                        name: "editable Test Case",
                    
                        setUp: function() {
                        
                            this.mockresponse = {
                                response: {
                                    results: [
                                        { "id" : "1", "name" : "Joe" },
                                        { "id" : "2", "name" : "Bob" },
                                        { "id" : "3", "name" : "Andrew" }
                                    ]
                                }
                            };

                            this.testDte = new Y.DataTable.Base({
                                columnset : [ 
                                    { key:"id", sortable: true },
                                    { key:"name", sortable: true }
                                ],
                                summary : "User patched DataTable Instance",
                                recordset : this.mockresponse.response.results
                            });

                            this.testDte.render();
                        },
                    
                        tearDown: function() {
                            this.testDte.destroy();
                            delete this.testDte;
                        },
                        
                        "test construction" : function() {
                            
                        },
                    
                        "test cell click fires on td click": function() {
                            var test = this,
                                evtFired = false;

                            this.testDte.on('cellClick', function(e) {
                                evtFired = true;
                            });
                         
                            this.testDte.get('contentBox').one('td').simulate('click');
                            
                            Y.Assert.isTrue(evtFired);
                        },
                        
                        // Make sure that setting events to the exact same values does not cause a change.
                        "test setting new events with the same values does not cause eventsChange": function() {
                            var defaultEvents = ['keydown', 'keyup', 'mousedown', 'mouseup', 'click', 'mouseover', 'mouseout', 'mouseenter', 'mouseleave', 'hover'],
                                currentEvents = this.testDte.get('events');
                            
                            Y.ArrayAssert.itemsAreEqual(defaultEvents, currentEvents, "Check test data is the same as object data"); 
                            
                            this.eventsChanged = false;
                            
                            this.testDte.after('eventsChange', function(e) {
                                Y.fail('eventsChange did fire when setting the same events');
                            }, this);
                            
                            this.testDte.set('events', defaultEvents);
                            
                            this.wait(function() {  
                                Y.Assert.isTrue(true, 'eventsChange event was not fired');
                            }, 200);
                        },
                        
                        "test setting new events with different values causes eventsChange" : function() {
                            var newEvents = ['click', 'keyup', 'mousedown', 'mouseover'],
                                evtFired = false;
                            
                            this.testDte.after('eventsChange', function(e) {
                                evtFired = true;
                            }, this);
                            
                            this.testDte.set('events', newEvents);
                            
                            Y.Assert.isTrue(evtFired, "test eventsChange event did fire after events change")
                        },
                        
                        "test preventing propagation after cellClick does not fire rowClick" : function() {
                            var test = this,
                                evtFired = false;

                            this.testDte.on('cellClick', function(e) {
                                evtFired = true;
                                e.event.preventPropagation();
                                return false;
                            });
                            
                            this.testDte.on('rowClick', function(e) {
                                Y.log('rowClick was fired');
                                Y.fail('rowClick was fired after event propagation stopped');
                            });
                         
                            this.testDte.get('contentBox').one('td').simulate('click');
                            
                            Y.Assert.isTrue(evtFired);
                        },
                        
                        "test event handler on cellClick does not cause race with rowClick" : function() {
                            var test = this,
                                evtFired = false;

                            this.testDte.on('cellClick', function(e) {
                                Y.log('cellClick was fired, now ill do something else');
                                
                                // Trying to force a big processing time for cellClick
                                for (i = 0; i < 100; i++) {
                                    var n = Y.one('#busywork' + i);
                                }
                                
                                Y.log('stopping cellClick propagation');
                                e.event.stopPropagation();
                            });
                            
                            this.testDte.on('rowClick', function(e) {
                                Y.log('rowClick was fired');
                                Y.fail('rowClick was fired after event propagation stopped');
                            });
                         
                            this.testDte.get('contentBox').one('td').simulate('click');
                            
                            this.wait(2000);
                            
                            Y.Assert.isTrue(evtFired);                            
                        }
                    });

                    var suite = new Y.Test.Suite({name:"DataTableEvents Test Suite"});
                    suite.add(testBasic);

                    Y.Test.Runner.setName("Test Runner");
                    Y.Test.Runner.add(suite);
                    Y.Test.Runner.run();
                });
            })();
        </script>
    </body>
</html>
